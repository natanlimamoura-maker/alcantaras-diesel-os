<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de O.S. Diesel</title>
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Oficina%20Diesel%22,%22short_name%22:%22DieselOS%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#d32f2f%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3059/3059251.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <meta name="theme-color" content="#d32f2f">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #eceff1; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        h2 { color: #d32f2f; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; }
        label { font-weight: bold; display: block; margin-top: 15px; color: #333; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .row { display: flex; gap: 10px; }
        .row div { flex: 1; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-pdf { background: #2e7d32; color: white; }
        .btn-clear { background: #757575; color: white; }
        .btn-config { background: #546e7a; color: white; margin-top: 20px; font-size: 14px; padding: 10px; }
        .btn-backup { background: #f57c00; color: white; margin-top: 10px; }
        #preview-img { width: 100px; height: 100px; object-fit: cover; margin-top: 10px; display: none; border-radius: 8px; border: 2px solid #d32f2f; }
        .historico { margin-top: 30px; border-top: 2px solid #ccc; padding-top: 10px; }
        .item-historico { background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #d32f2f; font-size: 13px; }
        .btn-rebaixar { background: #1976d2; color: white; padding: 5px 10px; width: auto; font-size: 12px; margin: 0; }
        #aba-config { display: none; padding: 15px; background: #f0f0f0; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="titulo-oficina">Alcantara's Diesel</h2>
    
    <div id="form-principal">
        <label>Cliente:</label>
        <input type="text" id="cliente" placeholder="Nome do Cliente">

        <div class="row">
            <div><label>Modelo:</label><input type="text" id="modelo" placeholder="Scania"></div>
            <div><label>Placa:</label><input type="text" id="placa" placeholder="ABC-1234"></div>
        </div>

        <label>KM Atual:</label>
        <input type="number" id="km" placeholder="500000">

        <label>Serviço Executado:</label>
        <textarea id="servico_exec" rows="3" placeholder="O que foi feito no veículo..."></textarea>

        <label>Orçamento (Serviço - Valor):</label>
        <textarea id="servicos_lista" rows="4" placeholder="Ex: Filtro - 100&#10;Mão de obra - 200" oninput="calcularTotal()"></textarea>
        
        <label>Valor Total (R$):</label>
        <input type="text" id="total" value="0.00" readonly style="background: #f9f9f9; font-weight: bold; color: #2e7d32;">

        <label>Foto:</label>
        <input type="file" id="foto" accept="image/*" onchange="processarFoto()">
        <img id="preview-img">

        <button class="btn-pdf" onclick="gerarPDF(true)">SALVAR E GERAR PDF</button>
        <button class="btn-clear" onclick="limparTudo()">LIMPAR TELA</button>
        
        <button class="btn-config" onclick="toggleConfig()">⚙️ CONFIGURAÇÕES E BACKUP</button>

        <div id="aba-config">
            <h3>Configurações</h3>
            <label>Nome da Oficina:</label>
            <input type="text" id="nome-oficina-input" placeholder="Ex: Alcantara's Diesel">
            <button class="btn-pdf" onclick="salvarConfig()">SALVAR NOME</button>
            <hr>
            <h3>Dados</h3>
            <button class="btn-backup" onclick="exportarBackup()">EXPORTAR BACKUP (.JSON)</button>
            <label>Importar Backup:</label>
            <input type="file" id="import-file" accept=".json" onchange="importarBackup()">
        </div>

        <div class="historico">
            <h3>Últimos Orçamentos</h3>
            <div id="lista-historico"></div>
        </div>
    </div>
</div>

<script>
    let fotoBase64 = "";
    let nomeOficina = "Alcantara's Diesel";

    window.onload = () => {
        const configSalva = localStorage.getItem('config_oficina');
        if(configSalva) {
            nomeOficina = configSalva;
            document.getElementById('titulo-oficina').innerText = nomeOficina;
            document.getElementById('nome-oficina-input').value = nomeOficina;
        }
        carregarHistorico();
    };

    function toggleConfig() {
        const aba = document.getElementById('aba-config');
        aba.style.display = aba.style.display === 'none' ? 'block' : 'none';
    }

    function salvarConfig() {
        const novoNome = document.getElementById('nome-oficina-input').value;
        if(novoNome) {
            localStorage.setItem('config_oficina', novoNome);
            location.reload();
        }
    }

    function calcularTotal() {
        const texto = document.getElementById('servicos_lista').value;
        const linhas = texto.split('\n');
        let soma = 0;
        linhas.forEach(linha => {
            const partes = linha.split('-');
            if(partes.length > 1) {
                const valor = parseFloat(partes[partes.length - 1].trim().replace(',', '.'));
                if(!isNaN(valor)) soma += valor;
            }
        });
        document.getElementById('total').value = soma.toFixed(2);
    }

    function processarFoto() {
        const file = document.getElementById('foto').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = img.height * (400 / img.width);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                fotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('preview-img').src = fotoBase64;
                document.getElementById('preview-img').style.display = "block";
            }
        };
        reader.readAsDataURL(file);
    }

    function gerarPDF(salvar = false) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = new Date().toLocaleDateString('pt-BR');
        
        const dados = {
            cliente: document.getElementById('cliente').value,
            placa: document.getElementById('placa').value,
            modelo: document.getElementById('modelo').value,
            km: document.getElementById('km').value,
            servico_exec: document.getElementById('servico_exec').value,
            servicos_lista: document.getElementById('servicos_lista').value,
            total: document.getElementById('total').value,
            foto: fotoBase64,
            data: data
        };

        if(salvar) {
            let historico = JSON.parse(localStorage.getItem('alcantara_history') || "[]");
            historico.unshift(dados);
            localStorage.setItem('alcantara_history', JSON.stringify(historico));
            carregarHistorico();
        }

        doc.setFillColor(211, 47, 47);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255);
        doc.setFontSize(22);
        doc.text(nomeOficina.toUpperCase(), 15, 25);
        doc.setFontSize(10);
        doc.text(`O.S. VEICULAR | Data: ${data}`, 15, 33);

        if (dados.foto) doc.addImage(dados.foto, 'JPEG', 150, 5, 45, 30);

        doc.setTextColor(0);
        doc.setFontSize(12);
        doc.text(`CLIENTE: ${dados.cliente}`, 15, 50);
        doc.text(`VEÍCULO: ${dados.modelo} | PLACA: ${dados.placa} | KM: ${dados.km}`, 15, 58);
        doc.line(15, 62, 195, 62);

        doc.setFont("helvetica", "bold");
        doc.text("SERVIÇO EXECUTADO:", 15, 72);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(doc.splitTextToSize(dados.servico_exec, 180), 15, 78);

        doc.setFont("helvetica", "bold");
        doc.text("ORÇAMENTO DETALHADO:", 15, 110);
        doc.setFont("helvetica", "normal");
        doc.text(doc.splitTextToSize(dados.servicos_lista, 180), 15, 116);

        doc.setFontSize(16);
        doc.setTextColor(46, 125, 50);
        doc.text(`TOTAL GERAL: R$ ${dados.total}`, 15, 160);

        doc.save(`OS_${dados.placa}.pdf`);
    }

    function carregarHistorico() {
        const historico = JSON.parse(localStorage.getItem('alcantara_history') || "[]");
        const lista = document.getElementById('lista-historico');
        lista.innerHTML = "";
        historico.slice(0, 15).forEach((item, index) => {
            const div = document.createElement('div');
            div.className = "item-historico";
            div.innerHTML = `<span><b>${item.placa}</b> (${item.data})</span><button class="btn-rebaixar" onclick="baixarDeNovo(${index})">PDF</button>`;
            lista.appendChild(div);
        });
    }

    function baixarDeNovo(index) {
        const historico = JSON.parse(localStorage.getItem('alcantara_history'));
        const d = historico[index];
        document.getElementById('cliente').value = d.cliente;
        document.getElementById('placa').value = d.placa;
        document.getElementById('modelo').value = d.modelo;
        document.getElementById('km').value = d.km;
        document.getElementById('servico_exec').value = d.servico_exec;
        document.getElementById('servicos_lista').value = d.servicos_lista;
        document.getElementById('total').value = d.total;
        fotoBase64 = d.foto;
        gerarPDF(false);
    }

    function exportarBackup() {
        const data = localStorage.getItem('alcantara_history');
        const blob = new Blob([data], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_oficina_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importarBackup() {
        const file = document.getElementById('import-file').files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            localStorage.setItem('alcantara_history', e.target.result);
            alert("Backup Restaurado!");
            location.reload();
        };
        reader.readAsText(file);
    }

    function limparTudo() { if(confirm("Limpar tela?")) location.reload(); }
</script>
</body>
</html>
