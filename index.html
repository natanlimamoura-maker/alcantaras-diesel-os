<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alcantara's Diesel</title>
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Alcantaras%20Diesel%22,%22short_name%22:%22Alcantaras%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#d32f2f%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3059/3059251.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <meta name="theme-color" content="#d32f2f">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3059/3059251.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #eceff1; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        h2 { color: #d32f2f; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; }
        label { font-weight: bold; display: block; margin-top: 15px; color: #333; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .row { display: flex; gap: 10px; }
        .row div { flex: 1; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-save { background: #1976d2; color: white; }
        .btn-pdf { background: #2e7d32; color: white; }
        .btn-clear { background: #757575; color: white; margin-top: 10px; width: 100%; }
        #preview-img { width: 100%; margin-top: 15px; display: none; border-radius: 8px; border: 2px solid #ddd; }
        .status { text-align: center; font-size: 12px; color: green; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>Alcantara's Diesel</h2>
    
    <label>Cliente:</label>
    <input type="text" id="cliente" placeholder="Nome do Cliente">

    <div class="row">
        <div>
            <label>Modelo:</label>
            <input type="text" id="modelo" placeholder="Ex: Scania R450">
        </div>
        <div>
            <label>Placa:</label>
            <input type="text" id="placa" placeholder="ABC-1234">
        </div>
    </div>

    <label>KM Atual:</label>
    <input type="number" id="km" placeholder="Ex: 500000">

    <label>Peças Utilizadas:</label>
    <textarea id="pecas" rows="3" placeholder="Descreva as peças..."></textarea>

    <label>Serviços e Valores:</label>
    <textarea id="servicos_lista" rows="4" placeholder="Ex: Troca de óleo - 200&#10;Revisão freios - 150" oninput="calcularTotal()"></textarea>
    
    <label>Valor Total (R$):</label>
    <input type="text" id="total" value="0.00" readonly style="background: #f9f9f9; font-weight: bold; color: #2e7d32;">

    <label>Foto (Câmera ou Galeria):</label>
    <input type="file" id="foto" accept="image/*" onchange="processarFoto()">
    <img id="preview-img">

    <div class="btn-group">
        <button class="btn-save" onclick="salvarDados()">SALVAR RASCUNHO</button>
        <button class="btn-pdf" onclick="gerarPDF()">GERAR PDF</button>
    </div>
    <button class="btn-clear" onclick="limparTudo()">NOVA O.S. (LIMPAR)</button>
    <div id="status" class="status">Dados salvos com sucesso! ✅</div>
</div>

<script>
    let fotoBase64 = "";

    function calcularTotal() {
        const texto = document.getElementById('servicos_lista').value;
        const linhas = texto.split('\n');
        let soma = 0;
        linhas.forEach(linha => {
            const partes = linha.split('-');
            if(partes.length > 1) {
                const valor = parseFloat(partes[partes.length - 1].trim().replace(',', '.'));
                if(!isNaN(valor)) soma += valor;
            }
        });
        document.getElementById('total').value = soma.toFixed(2);
    }

    function processarFoto() {
        const file = document.getElementById('foto').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const imgElement = new Image();
            imgElement.src = event.target.result;
            imgElement.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                const scaleSize = MAX_WIDTH / imgElement.width;
                canvas.width = MAX_WIDTH;
                canvas.height = imgElement.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
                fotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                const imgPreview = document.getElementById('preview-img');
                imgPreview.src = fotoBase64;
                imgPreview.style.display = "block";
            }
        };
        reader.readAsDataURL(file);
    }

    function salvarDados() {
        const dados = {
            cliente: document.getElementById('cliente').value,
            placa: document.getElementById('placa').value,
            modelo: document.getElementById('modelo').value,
            km: document.getElementById('km').value,
            pecas: document.getElementById('pecas').value,
            servicos_lista: document.getElementById('servicos_lista').value,
            total: document.getElementById('total').value,
            foto: fotoBase64
        };
        localStorage.setItem('os_alcantara_data', JSON.stringify(dados));
        document.getElementById('status').style.display = "block";
        setTimeout(() => document.getElementById('status').style.display = "none", 3000);
    }

    window.onload = () => {
        const salvos = localStorage.getItem('os_alcantara_data');
        if (salvos) {
            const d = JSON.parse(salvos);
            document.getElementById('cliente').value = d.cliente || '';
            document.getElementById('placa').value = d.placa || '';
            document.getElementById('modelo').value = d.modelo || '';
            document.getElementById('km').value = d.km || '';
            document.getElementById('pecas').value = d.pecas || '';
            document.getElementById('servicos_lista').value = d.servicos_lista || '';
            document.getElementById('total').value = d.total || '0.00';
            if (d.foto) {
                fotoBase64 = d.foto;
                document.getElementById('preview-img').src = fotoBase64;
                document.getElementById('preview-img').style.display = "block";
            }
        }
    };

    function limparTudo() {
        if(confirm("Limpar tudo para nova O.S?")) {
            localStorage.removeItem('os_alcantara_data');
            location.reload();
        }
    }

    async function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = new Date().toLocaleDateString('pt-BR');
        
        doc.setFontSize(22);
        doc.setTextColor(211, 47, 47);
        doc.text("ALCANTARA'S DIESEL", 105, 20, { align: "center" });
        
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text(`Ordem de Serviço | Data: ${data}`, 105, 28, { align: "center" });
        doc.line(10, 32, 200, 32);

        doc.setFontSize(12);
        doc.text(`Cliente: ${document.getElementById('cliente').value}`, 10, 40);
        doc.text(`Veículo: ${document.getElementById('modelo').value}`, 10, 48);
        doc.text(`Placa: ${document.getElementById('placa').value} | KM: ${document.getElementById('km').value}`, 10, 56);
        doc.line(10, 60, 200, 60);

        doc.text("Peças:", 10, 68);
        doc.setFontSize(10);
        doc.text(doc.splitTextToSize(document.getElementById('pecas').value, 180), 10, 74);

        doc.setFontSize(12);
        doc.text("Serviços Realizados:", 10, 100);
        doc.setFontSize(10);
        doc.text(doc.splitTextToSize(document.getElementById('servicos_lista').value, 180), 10, 106);

        doc.setFontSize(14);
        doc.setTextColor(46, 125, 50);
        doc.text(`VALOR TOTAL: R$ ${document.getElementById('total').value}`, 10, 150);

        if (fotoBase64) {
            doc.addPage();
            doc.setTextColor(0);
            doc.text("Anexo Fotográfico:", 10, 20);
            doc.addImage(fotoBase64, 'JPEG', 10, 30, 180, 0);
        }

        doc.save(`OS_${document.getElementById('placa').value}.pdf`);
    }
</script>

</body>
</html>
